<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Measuring Galaxy Redshifts with Cross-correlation â€” My Book
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html" rel="next" title="Point Source Aperture Photometry"/>
  <link href="../example_notebook/example_notebook.html" rel="prev" title="Draft: Notebook title"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/logo.png"/>
         <h1 class="site-logo" id="site-title">
          My Book
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
            Welcome to your Jupyter Book
           </a>
          </li>
         </ul>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra Part 3: Emission Line Map
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra Part 0: Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra Part 1: Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Part 2: Cross Correlation to Determine Redshift
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../example_notebook/example_notebook.html">
            Draft: Notebook title
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            Measuring Galaxy Redshifts with Cross-correlation
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://mybinder.org/v2/gh/TheRealZoidberg/renderTest/gh-storage?urlpath=tree/docs/notebooks/redshift_crosscorr/redshift_with_crosscorr.ipynb" title="Launch on Binder">
             <span class="headerbtn__icon-container">
              <img src="../../_static/images/logo_binder.svg"/>
             </span>
             <span class="headerbtn__text-container">
              Binder
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/TheRealZoidberg/renderTest" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/TheRealZoidberg/renderTest/issues/new?title=Issue%20on%20page%20%2Fnotebooks/redshift_crosscorr/redshift_with_crosscorr.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/redshift_crosscorr/redshift_with_crosscorr.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
           Matplotlib setup for plotting
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#define-data-files">
             Define data files:
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#read-observation-and-template">
             Read observation and template:
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#preprocess-spectra">
           Preprocess Spectra
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#subtract-continuum">
             Subtract continuum
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#smooth-observed-spectrum">
             Smooth observed spectrum
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#cross-correlate">
           Cross correlate
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#fit-correlation-peak">
           Fit correlation peak
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#visual-check">
           Visual check
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#case-with-lower-resolution-observed-spectrum">
           Case with lower resolution observed spectrum
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id1">
             Read observation and template:
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#id2">
           Preprocess Spectra
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id3">
             Subtract continuum
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id4">
             Smooth observed spectrum
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#id5">
           Cross correlate
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Measuring Galaxy Redshifts with Cross-correlation
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
              Matplotlib setup for plotting
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#define-data-files">
                Define data files:
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#read-observation-and-template">
                Read observation and template:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#preprocess-spectra">
              Preprocess Spectra
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#subtract-continuum">
                Subtract continuum
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#smooth-observed-spectrum">
                Smooth observed spectrum
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#cross-correlate">
              Cross correlate
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#fit-correlation-peak">
              Fit correlation peak
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#visual-check">
              Visual check
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#case-with-lower-resolution-observed-spectrum">
              Case with lower resolution observed spectrum
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id1">
                Read observation and template:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#id2">
              Preprocess Spectra
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id3">
                Subtract continuum
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id4">
                Smooth observed spectrum
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#id5">
              Cross correlate
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="measuring-galaxy-redshifts-with-cross-correlation">
          <h1>
           Measuring Galaxy Redshifts with Cross-correlation
           <a class="headerlink" href="#measuring-galaxy-redshifts-with-cross-correlation" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           This  notebook attempts to follow the workflow that uses IRAF tasks, described here
           <a class="reference external" href="http://tdc-www.harvard.edu/iraf/rvsao/xcsao/xcsao.proc.html">
            http://tdc-www.harvard.edu/iraf/rvsao/xcsao/xcsao.proc.html
           </a>
          </p>
          <p>
           Observed spectrum from LEGA-C: LEGA-C is a galaxy survey of about 3000 galaxies at z~0.8 and M* &gt; 10^10 M_sun in the COSMOS field. The spectra sample the rest-frame optical between ~3000A and 5000A at high resolution and very high signal-to-noise ratio. More information about the survey can be found here:
           <a class="reference external" href="http://www.mpia.de/home/legac/">
            http://www.mpia.de/home/legac/
           </a>
          </p>
          <p>
           Template from Pacifici et al. 2012.
          </p>
          <p>
           <strong>
            Developer Notes:
           </strong>
           - This workflow will be rendered in a few simple clicks in specviz
- Preparing the template outside the correlation function allows for applications to different science cases
          </p>
          <p>
           Author: Ivo Busko
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span>import os
import numpy as np

from scipy.signal.windows import tukey
import astropy
import astropy.units as u
from astropy.table import QTable
from astropy.nddata import StdDevUncertainty
from astropy.modeling.polynomial import Chebyshev1D
from astropy import constants as const
from astropy.io import fits, ascii
from astropy.wcs import WCS

import specutils
from specutils.fitting import continuum, find_lines_threshold, find_lines_derivative
from specutils import Spectrum1D
from specutils.manipulation import FluxConservingResampler, SplineInterpolatedResampler, LinearInterpolatedResampler
from specutils.analysis import correlation
from specutils import SpectralRegion
from specutils.manipulation import extract_region
from specutils.manipulation import linear_exciser
from specutils.manipulation import noise_region_uncertainty
from specutils.manipulation import gaussian_smooth, convolution_smooth

# Check versions
print("Numpy: ",np.__version__)
print("Astropy: ",astropy.__version__)
print("Specutils: ",specutils.__version__)
print("")
print("They should be:")
print("Numpy:  1.18.1")
print("Astropy:  4.0")
print("Specutils:  1.0")
</pre>
             </div>
            </div>
           </div>
          </div>
          <section id="matplotlib-setup-for-plotting">
           <h2>
            Matplotlib setup for plotting
            <a class="headerlink" href="#matplotlib-setup-for-plotting" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            There are two versions
           </p>
           <ul class="simple">
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                notebook
               </span>
              </code>
              â€“ gives interactive plots, but makes the overall notebook a bit harder to scroll
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                inline
               </span>
              </code>
              â€“ gives non-interactive plots for better overall scrolling
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import matplotlib.pyplot as plt

# Use this version for non-interactive plots (easier scrolling of the notebook)
%matplotlib inline

# Use this version if you want interactive plots
# %matplotlib notebook

# These gymnastics are needed to make the sizes of the figures
# be the same in both the inline and notebook versions
%config InlineBackend.print_figure_kwargs = {'bbox_inches': None}

plt.rcParams['savefig.dpi'] = 80
plt.rcParams['figure.dpi'] = 80
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="define-data-files">
            <h3>
             Define data files:
             <a class="headerlink" href="#define-data-files" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Files are on box

# Observation and weight.
file1d = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/legac_M1_v3.7_spec1d_130902.fits'
file1dwht = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/legac_M1_v3.7_wht1d_130902.fits'
# Template.
template_file = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/00006.dat'

# Plot limits
sp_xlim = [3000., 9000.]
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="read-observation-and-template">
            <h3>
             Read observation and template:
             <a class="headerlink" href="#read-observation-and-template" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Observation
hdu1d = fits.open(file1d)
hdu1dwht = fits.open(file1dwht)

flux = hdu1d[0].data
wht = hdu1dwht[0].data
unc = 1./ np.sqrt(wht)
wave = WCS(hdu1d[0]).pixel_to_world(np.arange(len(hdu1d[0].data)), 0)[0]

spec_unit = u.Unit('10^-19 erg s^-1 cm^-2 angstrom^-1')
dataspec = QTable([wave*u.angstrom, flux*spec_unit, wht, unc*spec_unit], 
                   names=('wavelength','flux','weight','uncertainty'))
dataspec_sub = dataspec[dataspec['weight']&gt;0.]
dataspec_sub
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Now make it into a Spectrum1D instance.
obs = Spectrum1D(spectral_axis=dataspec_sub['wavelength'], 
                 flux=dataspec_sub['flux'], 
                 uncertainty=StdDevUncertainty(dataspec_sub['uncertainty']))
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Template
template = ascii.read(template_file)
factor = 2.E-5 * obs.flux.unit # normalize template to a sensible range
template = Spectrum1D(spectral_axis=template['col1']*u.AA, 
                      flux=template['col2']*factor)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Note that in this and in subsequent plots, we are showing just the wavelength range of
# interest. The template covers a significantly wider range.
plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(obs.wavelength, obs.flux, linewidth=0.5, label='obs')
plt.plot(template.wavelength, template.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('Input data')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="preprocess-spectra">
           <h2>
            Preprocess Spectra
            <a class="headerlink" href="#preprocess-spectra" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="subtract-continuum">
            <h3>
             Subtract continuum
             <a class="headerlink" href="#subtract-continuum" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>continuum_model = continuum.fit_generic_continuum(obs) 
p_obs = obs - continuum_model(obs.wavelength)
continuum_model = continuum.fit_generic_continuum(template, model=Chebyshev1D(5)) 
p_template = template - continuum_model(template.wavelength)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(p_obs.wavelength, p_obs.flux, linewidth=0.5, label='obs')
plt.plot(p_template.wavelength, p_template.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('After continuum subtraction')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="smooth-observed-spectrum">
            <h3>
             Smooth observed spectrum
             <a class="headerlink" href="#smooth-observed-spectrum" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             The IRAF task XCORR works in Fourier space. In there, it applies a cosine bell filter (raised-cosine filter) to the observed spectrum, before multiplying together the two Fourier transforms. Here, we are working in data space, thus we emulate the filter operation by convolving the observed spectrum with a windowed sinc smoothing function.
            </p>
            <p>
             <strong>
              Developer Notes:
             </strong>
            </p>
            <ul class="simple">
             <li>
              <p>
               We should implement this window function in specutils so the user doe
snâ€™t have to:
               <a class="reference external" href="https://github.com/astropy/specutils/issues/636">
                https://github.com/astropy/specutils/issues/636
               </a>
              </p>
             </li>
             <li>
              <p>
               We should implement a fourier-space version of the xcorr as well as t
he current freq/wave-space version
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Smooth data with sinc kernel
fc = 0.25  # Cutoff frequency as a fraction of the sampling rate (in (0, 0.5)).
b = 0.49   # Transition band, as a fraction of the sampling rate (in (0, 0.5)).

# The IRAF task uses the above values. Here, we try
# a much lower cutoff frequency to really dampen the
# high frequency structure in the observed spectrum.
fc = 0.05 

N = int(np.ceil((4 / b)))
if not N % 2:  # N must be odd
    N += 1
n = np.arange(N)
 
# Compute sinc filter and Blackman window. Multiply filter 
# by window and normalize to get unity gain.
filt = np.sinc(2 * fc * (n - (N - 1) / 2))
w = 0.42 - 0.5 * np.cos(2 * np.pi * n / (N - 1)) + \
    0.08 * np.cos(4 * np.pi * n / (N - 1))
filt *= w
filt /= np.sum(filt)

# Smooth
p_obs_smoothed = convolution_smooth(p_obs, filt)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(p_obs_smoothed.wavelength, p_obs_smoothed.flux, linewidth=0.5, label='obs')
plt.plot(p_template.wavelength, p_template.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('After smoothing')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="cross-correlate">
           <h2>
            Cross correlate
            <a class="headerlink" href="#cross-correlate" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Correlation. 
#
# With no additional specifications, both the entire template and entire spectrum 
# will be included in the correlation computation. This in general will incur in 
# a significant increase in execution time. It is advised that the template is cut
# to work only on the useful region.

corr, lag = correlation.template_correlate(p_obs_smoothed, p_template)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.plot(lag, corr, linewidth=0.5)
plt.xlim(0,300000)
plt.xlabel(lag.unit)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Redshift based on maximum
index_peak = np.where(corr == np.amax(corr))[0][0]
v = lag[index_peak]
z = v / const.c.to('km/s')
print("Peak maximum at: ", v)
print("Redshift from peak maximum: ", z)
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="fit-correlation-peak">
           <h2>
            Fit correlation peak
            <a class="headerlink" href="#fit-correlation-peak" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Redshift based on parabolic fit to mazimum

n = 8 # points to the left or right of correlation maximum

peak_lags = lag[index_peak-n:index_peak+n+1].value
peak_vals = corr[index_peak-n:index_peak+n+1].value
p = np.polyfit(peak_lags, peak_vals, deg=2)
roots = np.roots(p)

v_fit = np.mean(roots) * u.km/u.s # maximum lies at mid point between roots
z = v_fit / const.c.to('km/s')

print("Parabolic fit with maximum at: ", v_fit)
print("Redshift from parabolic fit: ", z)
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="visual-check">
           <h2>
            Visual check
            <a class="headerlink" href="#visual-check" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plt.figure()
plt.gcf().set_size_inches((8.,4.))
# plt.xlim(sp_xlim)
plt.scatter(peak_lags, peak_vals, label='data')
plt.plot(peak_lags, np.polyval(p, peak_lags), linewidth=0.5, label='fit')
plt.xlabel(lag.unit)
plt.legend()
plt.title('Fit to correlation peak')
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>z_ref = 0.758 # "true" redshift, corresponding to 227242.6 km/s

template_z = Spectrum1D(spectral_axis=template.wavelength * (1.+z), flux=template.flux)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(obs.wavelength, obs.flux, linewidth=0.5, label='obs')
plt.plot(template_z.wavelength, template_z.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('Redshifted original template and original observed spectrum')
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>z_err = (z - z_ref) / z_ref * 100.
print("Error in the derived redshift: ", z_err, "%")
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="case-with-lower-resolution-observed-spectrum">
           <h2>
            Case with lower resolution observed spectrum
            <a class="headerlink" href="#case-with-lower-resolution-observed-spectrum" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="id1">
            <h3>
             Read observation and template:
             <a class="headerlink" href="#id1" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Observation
hdu1d = fits.open(file1d)
hdu1dwht = fits.open(file1dwht)

flux = hdu1d[0].data
wht = hdu1dwht[0].data
unc = 1./ np.sqrt(wht)
wave = np.arange(flux.shape[0])*hdu1d[0].header['CD1_1'] + hdu1d[0].header['CRVAL1']

spec_unit = u.Unit('10^-19 erg s^-1 cm^-2 angstrom^-1')
dataspec = QTable([wave*u.angstrom, flux*spec_unit, wht, unc*spec_unit], 
                   names=('wavelength','flux','weight','uncertainty'))
dataspec_sub = dataspec[dataspec['weight']&gt;0.]
dataspec_sub
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Now make it into a Spectrum1D instance.
obs_orig = Spectrum1D(spectral_axis=dataspec_sub['wavelength'], 
                 flux=dataspec_sub['flux'], 
                 uncertainty=StdDevUncertainty(dataspec_sub['uncertainty']))
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Change resolution of spectrum
obs = gaussian_smooth(obs_orig, stddev=15)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Template
template = ascii.read(template_file)
factor = 2.E-5 * obs.flux.unit # normalize template to a sensible range
template = Spectrum1D(spectral_axis=template['col1']*u.AA, 
                      flux=template['col2']*factor)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Note that in this and in subsequent plots, we are showing just the wavelength range of
# interest. The template covers a significantly wider range.
plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(obs.wavelength, obs.flux, linewidth=0.5, label='obs')
plt.plot(template.wavelength, template.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('Input data')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="id2">
           <h2>
            Preprocess Spectra
            <a class="headerlink" href="#id2" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="id3">
            <h3>
             Subtract continuum
             <a class="headerlink" href="#id3" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>continuum_model = continuum.fit_generic_continuum(obs) 
p_obs = obs - continuum_model(obs.wavelength)
continuum_model = continuum.fit_generic_continuum(template, model=Chebyshev1D(5)) 
p_template = template - continuum_model(template.wavelength)

plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(p_obs.wavelength, p_obs.flux, linewidth=0.5, label='obs')
plt.plot(p_template.wavelength, p_template.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('After continuum subtraction')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="id4">
            <h3>
             Smooth observed spectrum
             <a class="headerlink" href="#id4" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Smooth data with sinc kernel
fc = 0.25  # Cutoff frequency as a fraction of the sampling rate (in (0, 0.5)).
b = 0.49   # Transition band, as a fraction of the sampling rate (in (0, 0.5)).

# The IRAF task uses the above values. Here, we try
# a much lower cutoff frequency to really dampen the
# high frequency structure in the observed spectrum.
fc = 0.05 

N = int(np.ceil((4 / b)))
if not N % 2:  # N must be odd
    N += 1
n = np.arange(N)
 
# Compute sinc filter and Blackman window. Multiply filter 
# by window and normalize to get unity gain.
filt = np.sinc(2 * fc * (n - (N - 1) / 2))
w = 0.42 - 0.5 * np.cos(2 * np.pi * n / (N - 1)) + \
    0.08 * np.cos(4 * np.pi * n / (N - 1))
filt *= w
filt /= np.sum(filt)

# Smooth
p_obs_smoothed = convolution_smooth(p_obs, filt)

plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(p_obs_smoothed.wavelength, p_obs_smoothed.flux, linewidth=0.5, label='obs')
plt.plot(p_template.wavelength, p_template.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('After smoothing')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="id5">
           <h2>
            Cross correlate
            <a class="headerlink" href="#id5" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>corr, lag = correlation.template_correlate(p_obs_smoothed, p_template)

plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.plot(lag, corr, linewidth=0.5)
plt.xlim(0,300000)
plt.xlabel(lag.unit)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Redshift based on maximum
index_peak = np.where(corr == np.amax(corr))[0][0]
v = lag[index_peak]
z = v / const.c.to('km/s')
print("Peak maximum at: ", v)
print("Redshift from peak maximum: ", z)

# Redshift based on parabolic fit to mazimum

n = 8 # points to the left or right of correlation maximum

peak_lags = lag[index_peak-n:index_peak+n+1].value
peak_vals = corr[index_peak-n:index_peak+n+1].value
p = np.polyfit(peak_lags, peak_vals, deg=2)
roots = np.roots(p)

v_fit = np.mean(roots) * u.km/u.s # maximum lies at mid point between roots
z = v_fit / const.c.to('km/s')

print("")
print("Parabolic fit with maximum at: ", v_fit)
print("Redshift from parabolic fit: ", z)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>z_ref = 0.758 # "true" redshift, corresponding to 227242.6 km/s

template_z = Spectrum1D(spectral_axis=template.wavelength * (1.+z), flux=template.flux)

plt.figure()
plt.gcf().set_size_inches((8.,4.))
plt.xlim(sp_xlim)
plt.plot(obs.wavelength, obs.flux, linewidth=0.5, label='obs')
plt.plot(template_z.wavelength, template_z.flux, linewidth=0.5, color='r', label='template')
plt.legend()
plt.title('Redshifted original template and original observed spectrum')
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>z_err = (z - z_ref) / z_ref * 100.
print("Error in the derived redshift: ", z_err, "%")
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/redshift_crosscorr"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../example_notebook/example_notebook.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            Draft: Notebook title
           </p>
          </div>
         </a>
         <a class="right-next" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            Point Source Aperture Photometry
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By Captain Jupyter
        <br/>
        Â© Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>